<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#87CEEB" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.145.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Redis快速入门"><meta itemprop=description content="保持简单、易用、强大功能。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://szhiku.github.io/content/hugo_next_avatar.jpg"><meta itemprop=keywords content="运维,Linux,Redis"><meta property="og:type" content="article"><meta property="og:title" content="Redis快速入门"><meta property="og:description" content="保持简单、易用、强大功能。"><meta property="og:image" content="/content/hugo_next_avatar.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://szhiku.github.io/post/redis-fast-entry-2ltiy1.html"><meta property="og:site_name" content="szhiku.cn"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="szh"><meta property="article:published_time" content="2024-03-05 05:09:17 +0000 UTC"><meta property="article:modified_time" content="2024-03-05 12:35:57 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.8ea0817a6402d7fa3cdf50485ca3517c0b0774c939d76b920490340debb3cd98.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"redis-fast-entry-2ltiy1.html","permalink":"https://szhiku.github.io/post/redis-fast-entry-2ltiy1.html","title":"Redis快速入门","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Redis快速入门 - szhiku.cn</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>szhiku.cn</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>szh知识库</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>24</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#11-redis是什么>1.1 Redis是什么</a></li><li><a href=#12-redis重要特性>1.2 Redis重要特性</a><ul><li><a href=#1速度快>1.速度快</a></li><li><a href=#2基于键值对的数据结构服务器>2.基于键值对的数据结构服务器</a></li><li><a href=#3丰富的功能>3.丰富的功能</a></li><li><a href=#4简单稳定>4.简单稳定</a></li><li><a href=#5客户端语言多>5.客户端语言多</a></li><li><a href=#6持久化>6.持久化</a></li><li><a href=#7主从复制>7.主从复制</a></li><li><a href=#8高可用和分布式>8.高可用和分布式</a></li></ul></li><li><a href=#13-redis应用场景>1.3 Redis应用场景</a><ul><li><a href=#1缓存-键过期时间>1.缓存-键过期时间</a></li><li><a href=#2排行榜-列表有序集合>2.排行榜-列表&有序集合</a></li><li><a href=#3计数器应用-天然支持计数器>3.计数器应用-天然支持计数器</a></li><li><a href=#4社交网络-集合>4.社交网络-集合</a></li><li><a href=#5消息队列系统-发布订阅>5.消息队列系统-发布订阅</a></li></ul></li></ul><ul><li><a href=#21-目录规划>2.1 目录规划</a></li><li><a href=#22-安装命令>2.2 安装命令</a><ul><li><a href=#编辑hosts文件>编辑hosts文件</a></li></ul></li><li><a href=#23-配置文件说明>2.3 配置文件说明</a></li><li><a href=#24-启动关闭服务>2.4 启动关闭服务</a><ul><li><a href=#启动>启动</a></li><li><a href=#关闭>关闭</a></li></ul></li></ul><ul><li><a href=#31-全局命令>3.1 全局命令</a></li></ul><ul><li><a href=#32-字符串>3.2 字符串</a></li><li><a href=#33-列表>3.3 列表</a></li></ul><ul><li><a href=#41-持久化的两种方式介绍>4.1 持久化的两种方式介绍</a></li><li><a href=#42-面试题>4.2 面试题</a></li></ul><ul><li><a href=#61-主从复制介绍>6.1 主从复制介绍</a></li><li><a href=#62-配置命令>6.2 配置命令</a><ul><li><a href=#621-建立复制>6.2.1 建立复制</a></li><li><a href=#622-断开复制>6.2.2 断开复制</a></li></ul></li></ul><ul><li><a href=#71-哨兵介绍>7.1 哨兵介绍</a></li><li><a href=#72-哨兵主要功能>7.2 哨兵主要功能</a></li><li><a href=#73-目录规划>7.3 目录规划</a></li><li><a href=#74-安装配置命令>7.4 安装配置命令</a><ul><li><a href=#741-db01命令>7.4.1 db01命令</a></li><li><a href=#742-配置文件解释>7.4.2 配置文件解释</a></li><li><a href=#743-db02db03命令>7.4.3 db02/db03命令</a></li><li><a href=#744-配置主从关系>7.4.4 配置主从关系</a></li><li><a href=#745-启动哨兵>7.4.5 启动哨兵</a></li></ul></li><li><a href=#75-配置文件的变化>7.5 配置文件的变化</a></li><li><a href=#76-哨兵常用操作api>7.6 哨兵常用操作API</a></li><li><a href=#77-模拟故障转移>7.7 模拟故障转移</a></li></ul><ul><li><a href=#81-集群介绍>8.1 集群介绍</a></li><li><a href=#82-数据分布>8.2 数据分布</a></li><li><a href=#83-目录规划>8.3 目录规划</a></li><li><a href=#84-集群拓扑>8.4 集群拓扑</a></li><li><a href=#85-手动搭建部署集群>8.5 手动搭建部署集群</a><ul><li><a href=#851-手动配置节点发现>8.5.1 手动配置节点发现</a></li><li><a href=#852-redis-cluster-通讯流程>8.5.2 Redis Cluster 通讯流程</a></li><li><a href=#853-redis-cluster手动分配槽位>8.5.3 Redis Cluster手动分配槽位</a></li><li><a href=#854-手动配置集群高可用>8.5.4 手动配置集群高可用</a></li><li><a href=#855-测试集群>8.5.5 测试集群</a></li></ul></li><li><a href=#86-redis-cluster测试集群>8.6 Redis Cluster测试集群</a></li><li><a href=#87-redis-cluster-ask路由介绍>8.7 Redis Cluster ASK路由介绍</a></li><li><a href=#88-模拟故障转移>8.8 模拟故障转移</a></li><li><a href=#89-使用工具搭建部署redis-cluster>8.9 使用工具搭建部署Redis Cluster</a></li><li><a href=#810-工具扩容节点>8.10 工具扩容节点</a></li><li><a href=#811-工具收缩节点>8.11 工具收缩节点</a></li><li><a href=#812-忘记节点>8.12 忘记节点</a></li></ul><ul><li><a href=#101-运维脚本>10.1 运维脚本</a></li><li><a href=#102-数据导入导出工具>10.2 数据导入导出工具</a></li><li><a href=#103-分析键值大小>10.3 分析键值大小</a></li><li><a href=#104-监控过期键>10.4 监控过期键</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=szh src=/imgs/img-lazy-loading.gif data-src=/content/hugo_next_avatar.jpg><p class=site-author-name itemprop=name>szh</p><div class=site-description itemprop=description>保持简单、易用、强大功能。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>24</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>3</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>15</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/szhiku title="Github → https://github.com/szhiku" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=aaa467843177@qq.com title="E-Mail → aaa467843177@qq.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail
</a></span><span class=links-of-social-item><a href=https://www.zhihu.com/people/feng-ying-xia-3 title="知乎 → https://www.zhihu.com/people/feng-ying-xia-3" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>
知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2022-06-08T21:12:52+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=85785></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=182></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-02-19T03:06:22+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://szhiku.github.io/post/redis-fast-entry-2ltiy1.html><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/content/hugo_next_avatar.jpg"><meta itemprop=name content="szh"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="szh"><meta itemprop=description content="保持简单、易用、强大功能。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Redis快速入门"><meta itemprop=description content="Redis快速入门

第1章 Redis介绍

1.1 Redis是什么

　　Redis是一种基于键值对的NoSQL数据库,与很多键值对数据库不同,redis中的值可以有string,hash,list,set,zset,geo等多种数据结构和算法组成.
因为Redis会将所有的数据都放在内存中,所以他的读写性能非常惊人.
不仅如此,Redis还可以将内存中的数据利用快照和日志的形式保存到硬盘上
Redis还提供了键过期,发布订阅,事务,流水线等附加功能."></span><header class=post-header><h1 class=post-title itemprop="name headline">Redis快速入门</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-03-05 05:09:17 +0000 UTC" itemprop="dateCreated datePublished" datetime="2024-03-05 05:09:17 +0000 UTC">2024-03-05
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i>
</span><span class=post-meta-item-text title=更新于>更新于：
</span><time title=修改时间：2024-03-05T12:35:57+00:00 itemprop=dateModified datetime=2024-03-05T12:35:57+00:00>2024-03-05</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>10687</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>22分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/redis-fast-entry-2ltiy1.html><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h1 id=redis快速入门>Redis快速入门
<a class=header-anchor href=#redis%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8></a></h1><h1 id=第1章-redis介绍>第1章 Redis介绍
<a class=header-anchor href=#%e7%ac%ac1%e7%ab%a0-redis%e4%bb%8b%e7%bb%8d></a></h1><h2 id=11-redis是什么>1.1 Redis是什么
<a class=header-anchor href=#11-redis%e6%98%af%e4%bb%80%e4%b9%88></a></h2><p>　　Redis是一种基于键值对的NoSQL数据库,与很多键值对数据库不同,redis中的值可以有string,hash,list,set,zset,geo等多种数据结构和算法组成.<br>因为Redis会将所有的数据都放在内存中,所以他的读写性能非常惊人.<br>不仅如此,Redis还可以将内存中的数据利用快照和日志的形式保存到硬盘上<br>Redis还提供了键过期,发布订阅,事务,流水线等附加功能.</p><h2 id=12-redis重要特性>1.2 Redis重要特性
<a class=header-anchor href=#12-redis%e9%87%8d%e8%a6%81%e7%89%b9%e6%80%a7></a></h2><h3 id=1速度快>1.速度快
<a class=header-anchor href=#1%e9%80%9f%e5%ba%a6%e5%bf%ab></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Redis所有的数据都存放在内存中
</span></span><span style=display:flex><span>Redis使用C语言实现
</span></span><span style=display:flex><span>Redis使用单线程架构
</span></span></code></pre></div><h3 id=2基于键值对的数据结构服务器>2.基于键值对的数据结构服务器
<a class=header-anchor href=#2%e5%9f%ba%e4%ba%8e%e9%94%ae%e5%80%bc%e5%af%b9%e7%9a%84%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e6%9c%8d%e5%8a%a1%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>5中数据结构:字符串,哈希,列表,集合,有序集合
</span></span></code></pre></div><h3 id=3丰富的功能>3.丰富的功能
<a class=header-anchor href=#3%e4%b8%b0%e5%af%8c%e7%9a%84%e5%8a%9f%e8%83%bd></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>提供了键过期功能,可以实现缓存
</span></span><span style=display:flex><span>提供了发布订阅功能,可以实现消息系统
</span></span><span style=display:flex><span>提供了pipeline功能,客户端可以将一批命令一次性传到Redis,减少了网络开销
</span></span></code></pre></div><h3 id=4简单稳定>4.简单稳定
<a class=header-anchor href=#4%e7%ae%80%e5%8d%95%e7%a8%b3%e5%ae%9a></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>源码很少</span><span style=color:#f92672>,</span><span style=color:#f92672>3</span>.<span style=color:#a6e22e>0版本以后5万行左右</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>使用单线程模型法</span><span style=color:#f92672>,</span><span style=color:#f92672>是的Redis服务端处理模型变得简单</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>不依赖操作系统的中的类库</span>
</span></span></code></pre></div><h3 id=5客户端语言多>5.客户端语言多
<a class=header-anchor href=#5%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%ad%e8%a8%80%e5%a4%9a></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>java,PHP,python,C,C++,Nodejs等
</span></span></code></pre></div><h3 id=6持久化>6.持久化
<a class=header-anchor href=#6%e6%8c%81%e4%b9%85%e5%8c%96></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>RDB和AOF
</span></span></code></pre></div><h3 id=7主从复制>7.主从复制
<a class=header-anchor href=#7%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6></a></h3><h3 id=8高可用和分布式>8.高可用和分布式
<a class=header-anchor href=#8%e9%ab%98%e5%8f%af%e7%94%a8%e5%92%8c%e5%88%86%e5%b8%83%e5%bc%8f></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>哨兵
</span></span><span style=display:flex><span>集群
</span></span></code></pre></div><h2 id=13-redis应用场景>1.3 Redis应用场景
<a class=header-anchor href=#13-redis%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af></a></h2><h3 id=1缓存-键过期时间>1.缓存-键过期时间
<a class=header-anchor href=#1%e7%bc%93%e5%ad%98-%e9%94%ae%e8%bf%87%e6%9c%9f%e6%97%b6%e9%97%b4></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>缓存session会话
</span></span><span style=display:flex><span>缓存用户信息,找不到再去mysql查,查到然后回写到redis
</span></span></code></pre></div><h3 id=2排行榜-列表有序集合>2.排行榜-列表&有序集合
<a class=header-anchor href=#2%e6%8e%92%e8%a1%8c%e6%a6%9c-%e5%88%97%e8%a1%a8%e6%9c%89%e5%ba%8f%e9%9b%86%e5%90%88></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>热度排名排行榜
</span></span><span style=display:flex><span>发布时间排行榜
</span></span></code></pre></div><h3 id=3计数器应用-天然支持计数器>3.计数器应用-天然支持计数器
<a class=header-anchor href=#3%e8%ae%a1%e6%95%b0%e5%99%a8%e5%ba%94%e7%94%a8-%e5%a4%a9%e7%84%b6%e6%94%af%e6%8c%81%e8%ae%a1%e6%95%b0%e5%99%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>帖子浏览数
</span></span><span style=display:flex><span>视频播放次数
</span></span><span style=display:flex><span>商品浏览数
</span></span></code></pre></div><h3 id=4社交网络-集合>4.社交网络-集合
<a class=header-anchor href=#4%e7%a4%be%e4%ba%a4%e7%bd%91%e7%bb%9c-%e9%9b%86%e5%90%88></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>踩/赞,粉丝,共同好友/喜好,推送,打标签
</span></span></code></pre></div><h3 id=5消息队列系统-发布订阅>5.消息队列系统-发布订阅
<a class=header-anchor href=#5%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e7%b3%bb%e7%bb%9f-%e5%8f%91%e5%b8%83%e8%ae%a2%e9%98%85></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>配合elk实现日志收集
</span></span></code></pre></div><h1 id=第2章-redis安装部署>第2章 Redis安装部署
<a class=header-anchor href=#%e7%ac%ac2%e7%ab%a0-redis%e5%ae%89%e8%a3%85%e9%83%a8%e7%bd%b2></a></h1><h2 id=21-目录规划>2.1 目录规划
<a class=header-anchor href=#21-%e7%9b%ae%e5%bd%95%e8%a7%84%e5%88%92></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>### redis下载目录</span>
</span></span><span style=display:flex><span>/data/soft/
</span></span><span style=display:flex><span><span style=color:#75715e>### redis安装目录</span>
</span></span><span style=display:flex><span>/opt/redis_cluster/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>conf,logs,pid<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>### redis数据目录</span>
</span></span><span style=display:flex><span>/data/redis_cluster/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>.rdb
</span></span><span style=display:flex><span><span style=color:#75715e>### redis运维脚本</span>
</span></span><span style=display:flex><span>/root/scripts/redis_shell.sh
</span></span></code></pre></div><h2 id=22-安装命令>2.2 安装命令
<a class=header-anchor href=#22-%e5%ae%89%e8%a3%85%e5%91%bd%e4%bb%a4></a></h2><h3 id=编辑hosts文件>编辑hosts文件
<a class=header-anchor href=#%e7%bc%96%e8%be%91hosts%e6%96%87%e4%bb%b6></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> tail -<span style=color:#ae81ff>3</span> /etc/hosts
</span></span><span style=display:flex><span><span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.51</span> db01  
</span></span><span style=display:flex><span><span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.52</span> db02  
</span></span><span style=display:flex><span><span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.53</span> db03
</span></span><span style=display:flex><span>mkdir -p /<span style=color:#66d9ef>data</span>/soft
</span></span><span style=display:flex><span>mkdir -p /<span style=color:#66d9ef>data</span>/redis_cluster/redis_6379
</span></span><span style=display:flex><span>mkdir -p /opt/redis_cluster/redis_6379/{conf,pid,logs}
</span></span><span style=display:flex><span>cd /<span style=color:#66d9ef>data</span>/soft/
</span></span><span style=display:flex><span>wget http:<span style=color:#75715e>//download.redis.io/releases/redis-3.2.9.tar.gz
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>tar zxf redis-<span style=color:#ae81ff>3.2</span>.<span style=color:#ae81ff>9.</span>tar.gz -C /opt/redis_cluster/
</span></span><span style=display:flex><span>ln -s /opt/redis_cluster/redis-<span style=color:#ae81ff>3.2</span>.<span style=color:#ae81ff>9</span>/ /opt/redis_cluster/redis
</span></span><span style=display:flex><span>cd /opt/redis_cluster/redis
</span></span><span style=display:flex><span>make <span style=color:#f92672>&amp;&amp;</span> make install
</span></span></code></pre></div><h2 id=23-配置文件说明>2.3 配置文件说明
<a class=header-anchor href=#23-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>### 以守护进程模式启动</span>
</span></span><span style=display:flex><span>daemonize yes
</span></span><span style=display:flex><span><span style=color:#75715e>### 绑定的主机地址</span>
</span></span><span style=display:flex><span>bind 10.0.0.51
</span></span><span style=display:flex><span><span style=color:#75715e>### 监听端口</span>
</span></span><span style=display:flex><span>port <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span><span style=color:#75715e>### pid文件和log文件的保存地址</span>
</span></span><span style=display:flex><span>pidfile /opt/redis_cluster/redis_6379/pid/redis_6379.pid
</span></span><span style=display:flex><span>logfile /opt/redis_cluster/redis_6379/logs/redis_6379.log
</span></span><span style=display:flex><span><span style=color:#75715e>### 设置数据库的数量，默认数据库为0</span>
</span></span><span style=display:flex><span>databases <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span><span style=color:#75715e>### 指定本地持久化文件的文件名,默认是dump.rdb</span>
</span></span><span style=display:flex><span>dbfilename redis_6379.rdb
</span></span><span style=display:flex><span><span style=color:#75715e>### 本地数据库的目录</span>
</span></span><span style=display:flex><span>dir /data/redis_cluster/redis_6379
</span></span></code></pre></div><h2 id=24-启动关闭服务>2.4 启动关闭服务
<a class=header-anchor href=#24-%e5%90%af%e5%8a%a8%e5%85%b3%e9%97%ad%e6%9c%8d%e5%8a%a1></a></h2><h3 id=启动>启动
<a class=header-anchor href=#%e5%90%af%e5%8a%a8></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-server /opt/redis_cluster/redis_6379/conf/redis_6379.conf
</span></span></code></pre></div><h3 id=关闭>关闭
<a class=header-anchor href=#%e5%85%b3%e9%97%ad></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db01 shutdown
</span></span></code></pre></div><h1 id=第3章-redis基本操作命令>第3章 Redis基本操作命令
<a class=header-anchor href=#%e7%ac%ac3%e7%ab%a0-redis%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c%e5%91%bd%e4%bb%a4></a></h1><h2 id=31-全局命令>3.1 全局命令
<a class=header-anchor href=#31-%e5%85%a8%e5%b1%80%e5%91%bd%e4%bb%a4></a></h2><p>　　Redis有5种数据结构,他们是键值对中的值,对于键来说有一些通用的命令.<br>1.查看所有命键</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Keys *  
</span></span></code></pre></div><h1 id=十分危险的命令线上禁止使用>十分危险的命令,线上禁止使用
<a class=header-anchor href=#%e5%8d%81%e5%88%86%e5%8d%b1%e9%99%a9%e7%9a%84%e5%91%bd%e4%bb%a4%e7%ba%bf%e4%b8%8a%e7%a6%81%e6%ad%a2%e4%bd%bf%e7%94%a8></a></h1><p>　　2.查看键的总数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>Dbsize 
</span></span><span style=display:flex><span><span style=color:#75715e># dbsize 命令在计算键总数时不会遍历所有键,而是直接获取Redis内置的键总数变量.</span>
</span></span></code></pre></div><p>　　3.检查键是否存在</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>Exists key
</span></span><span style=display:flex><span><span style=color:#75715e># 如果键存在则返回1,不存在则返回0</span>
</span></span></code></pre></div><p>　　4.删除键</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>Del</span> <span style=color:#f92672>key</span> <span style=color:#f92672>[</span><span style=color:#f92672>key</span> <span style=color:#960050;background-color:#1e0010>…</span><span style=color:#f92672>]</span>
</span></span></code></pre></div><h1 id=通用命令无论值是什么数据结构类型del命令都可以将其删除>通用命令,无论值是什么数据结构类型,del命令都可以将其删除.
<a class=header-anchor href=#%e9%80%9a%e7%94%a8%e5%91%bd%e4%bb%a4%e6%97%a0%e8%ae%ba%e5%80%bc%e6%98%af%e4%bb%80%e4%b9%88%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e7%b1%bb%e5%9e%8bdel%e5%91%bd%e4%bb%a4%e9%83%bd%e5%8f%af%e4%bb%a5%e5%b0%86%e5%85%b6%e5%88%a0%e9%99%a4></a></h1><p>　　5.键过期</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>Expire key seconds
</span></span><span style=display:flex><span><span style=color:#75715e># Redis支持对键添加过期时间,当超过过期时间后,会自动删除键.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 通过ttl命令观察键的剩余时间</span>
</span></span><span style=display:flex><span>大于等于0的证书: 键剩余过期时间
</span></span><span style=display:flex><span>-1: 键没设置过期时间
</span></span><span style=display:flex><span>-2: 键不存在
</span></span></code></pre></div><p>　　6.键的数据类型</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dart data-lang=dart><span style=display:flex><span>Type key
</span></span></code></pre></div><h2 id=32-字符串>3.2 字符串
<a class=header-anchor href=#32-%e5%ad%97%e7%ac%a6%e4%b8%b2></a></h2><p>　　Redis并不是简单地key-value存储,实际上他是一个数据结构服务器,支持不同类型的值.<br>Redis Strings<br>这是最简单的Redis类型,如果你只用这种类型,Redis就像一个持久化的memcache服务器(注:memcache的数据仅保存在内存中,服务器重启后,数据将丢失.)<br>操作命令:<br>通常用SET command 和 GET command来设置和获取字符串值<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span>&gt; <span style=color:#66d9ef>set</span> key1 value1
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span>&gt; <span style=color:#66d9ef>get</span> key1
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;value1&#34;</span>
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span>&gt; keys *
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>) <span style=color:#e6db74>&#34;key1&#34;</span>
</span></span></code></pre></div><p>　　操作命令:<br>INCR命令将字符串值解析成整型.将其加1,最后结果保存为新的字符串,类似命令: INCRBY,DECR,DECRBY<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dart data-lang=dart><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> key2 <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>get</span> key2
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;100&#34;</span>
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> incr key2
</span></span><span style=display:flex><span>(integer) <span style=color:#ae81ff>101</span>
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>get</span> key2
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;101&#34;</span>
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> incrby key2 <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>(integer) <span style=color:#ae81ff>111</span>
</span></span><span style=display:flex><span>db01:<span style=color:#ae81ff>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>get</span> key2
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;111&#34;</span>
</span></span></code></pre></div><p>　　操作命令:<br>MSET和MGET可以一次存储或获取多个key对应的值.<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; mset key3 v3 key4 v4 key5 v5
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:6379&gt; mget key3 key4 key5
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;v3&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;v4&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;v5&#34;</span>
</span></span></code></pre></div><p>　　操作命令:<br>EXISTS命令返回1或0标识给定key的值是否存在.<br>使用DEL命令可以删除key对应的值,<br>DEL命令返回1或0标识是被删除(值存在)或者没被删除(key对应的值不存在).<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; exists key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>db01:6379&gt; del key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>db01:6379&gt; exists key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>db01:6379&gt; del key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>　　操作命令:<br>Type命令可以返回key对应的存储类型<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#a6e22e>db01</span>:<span style=color:#66d9ef>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>set</span> <span style=color:#a6e22e>key5</span> <span style=color:#a6e22e>v5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>db01</span>:<span style=color:#66d9ef>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>key5</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>string</span>
</span></span></code></pre></div><p>　　操作命令:<br>可以对key设置一个超时时间,当这个时间到达后被删除<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>get</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;v5&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>-1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>expire</span> <span style=color:#f92672>key5</span> <span style=color:#f92672>10</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>-2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>ttl</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>integer</span><span style=color:#f92672>)</span> <span style=color:#f92672>-2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>get</span> <span style=color:#f92672>key5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>nil</span><span style=color:#f92672>)</span>
</span></span></code></pre></div><p>　　操作命令:<br>PERSIST命令去除超时时间<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; set key5 v5 ex <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:6379&gt; ttl key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>db01:6379&gt; ttl key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>db01:6379&gt; persist key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>db01:6379&gt; ttl key5
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> -1
</span></span></code></pre></div><h2 id=33-列表>3.3 列表
<a class=header-anchor href=#33-%e5%88%97%e8%a1%a8></a></h2><p>　　操作命令:<br>LPUSH命令可向list的左边(头部)添加一个新元素<br>RPUSH命令可向list的右边(尾部)添加一个新元素.<br>最后LRANGE可以从list中取出一定范围的元素<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; rpush list1 A
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>db01:6379&gt; rpush list1 B
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>db01:6379&gt; lpush list1 top1
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>db01:6379&gt; lrange list1 <span style=color:#ae81ff>0</span> -1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;top1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;B&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; lrange list1 <span style=color:#ae81ff>1</span> -1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;B&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; lrange list1 <span style=color:#ae81ff>2</span> -1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;B&#34;</span>
</span></span></code></pre></div><p>　　操作命令:<br>Pop,从list中删除元素并同时返回删除的值,可以在左边或右边操作.<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; rpop list1
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;B&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; lrange list1 <span style=color:#ae81ff>0</span> -1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;top1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; lpop list1
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;top1&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; lrange list1 <span style=color:#ae81ff>0</span> -1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;A&#34;</span>
</span></span></code></pre></div><p>　　3.4 哈希<br>操作命令:<br>Hash看起来就像一个’hash’的样子.由键值对组成<br>HMSET指令设置hash中的多个域<br>HGET取回单个域.<br>HMGET取回一系列的值<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; hmset user:1000 username zhangya age <span style=color:#ae81ff>27</span> job it
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:6379&gt; hget user:1000 username
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;zhangya&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; hmget user:1000 username age job
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;zhangya&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;27&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;it&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; hgetall user:1000
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;username&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;zhangya&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;27&#34;</span>
</span></span><span style=display:flex><span>5<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;job&#34;</span>
</span></span><span style=display:flex><span>6<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;it&#34;</span>
</span></span><span style=display:flex><span>db01:6379&gt; hmset user:1000 qq <span style=color:#ae81ff>526195417</span>
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>db01:6379&gt; hgetall user:1000
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;username&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;zhangya&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;27&#34;</span>
</span></span><span style=display:flex><span>5<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;job&#34;</span>
</span></span><span style=display:flex><span>6<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;it&#34;</span>
</span></span><span style=display:flex><span>7<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;qq&#34;</span>
</span></span><span style=display:flex><span>8<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;526195417&#34;</span>
</span></span></code></pre></div><p>　　3.5 集合<br>操作命令:<br>集合是字符串的无序排列,<br>SADD指令把新的元素添加到set中<br>练习:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; sadd set1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>db01:6379&gt; smembers set1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span></code></pre></div><p>　　和list类型不同,set集合不允许出现重复的元素</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; sadd set1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>db01:6379&gt; smembers set1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;4&#34;</span>
</span></span></code></pre></div><p>　　Srem用来删除指定的值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; srem set1 <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>db01:6379&gt; smembers set1
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span></code></pre></div><p>　　Sdiff计算集合的差异成员</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; sadd set1 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>db01:6379&gt; sadd set2 <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>integer<span style=color:#f92672>)</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>db01:6379&gt; sdiff set1 set2
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span></code></pre></div><p>　　Sinter计算集合的交集</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; sinter set1 set2
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;4&#34;</span>
</span></span></code></pre></div><p>　　Sunion计算集合并集</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>db01:6379&gt; sunion set1 set2
</span></span><span style=display:flex><span>1<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>2<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>3<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>4<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;4&#34;</span>
</span></span><span style=display:flex><span>5<span style=color:#f92672>)</span> <span style=color:#e6db74>&#34;5&#34;</span>
</span></span></code></pre></div><h1 id=第4章-redis持久化>第4章 Redis持久化
<a class=header-anchor href=#%e7%ac%ac4%e7%ab%a0-redis%e6%8c%81%e4%b9%85%e5%8c%96></a></h1><h2 id=41-持久化的两种方式介绍>4.1 持久化的两种方式介绍
<a class=header-anchor href=#41-%e6%8c%81%e4%b9%85%e5%8c%96%e7%9a%84%e4%b8%a4%e7%a7%8d%e6%96%b9%e5%bc%8f%e4%bb%8b%e7%bb%8d></a></h2><p>　　RDB 持久化优缺点<br>可以在指定的时间间隔内生成数据集的 时间点快照（point-in-time snapshot）。<br>优点：速度快，适合于用做备份，主从复制也是基于RDB持久化功能实现的。<br>缺点：会有数据丢失<br>rdb持久化核心配置参数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>vim /data/6379/redis.conf
</span></span><span style=display:flex><span>dir /data/6379
</span></span><span style=display:flex><span>dbfilename dump.rdb
</span></span><span style=display:flex><span>save <span style=color:#ae81ff>900</span> <span style=color:#ae81ff>1</span>      <span style=color:#75715e>#900秒（15分钟）内有1个更改</span>
</span></span><span style=display:flex><span>save <span style=color:#ae81ff>300</span> <span style=color:#ae81ff>10</span>     <span style=color:#75715e>#300秒（5分钟）内有10个更改</span>
</span></span><span style=display:flex><span>save <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>10000</span>   <span style=color:#75715e>#60秒内有10000个更改  </span>
</span></span></code></pre></div><p>　　AOF 持久化(append-only log file)优缺点<br>记录服务器执行的所有写操作命令，并在服务器启动时，通过重新执行这些命令来还原数据集。<br>AOF 文件中的命令全部以 Redis 协议的格式来保存，新命令会被追加到文件的末尾。<br>优点：可以最大程度保证数据不丢<br>缺点：日志记录量级比较大</p><p>　　AOF持久化配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>appendonly yes          <span style=color:#75715e>#是否打开aof日志功能</span>
</span></span><span style=display:flex><span>appendfsync always      <span style=color:#75715e>#每1个命令,都立即同步到aof</span>
</span></span><span style=display:flex><span>appendfsync everysec    <span style=color:#75715e>#每秒写1次</span>
</span></span><span style=display:flex><span>appendfsync no          <span style=color:#75715e>#写入工作交给操作系统,由操作系统判断缓冲区大小,统一写入到aof.</span>
</span></span></code></pre></div><h2 id=42-面试题>4.2 面试题
<a class=header-anchor href=#42-%e9%9d%a2%e8%af%95%e9%a2%98></a></h2><p>　　redis 持久化方式有哪些？有什么区别？<br>rdb：基于快照的持久化，速度更快，一般用作备份，主从复制也是依赖于rdb持久化功能<br>aof：以追加的方式记录redis操作日志的文件。可以最大程度的保证redis数据安全，类似于mysql的binlog</p><h1 id=第5章-redis安全认证>第5章 Redis安全认证
<a class=header-anchor href=#%e7%ac%ac5%e7%ab%a0-redis%e5%ae%89%e5%85%a8%e8%ae%a4%e8%af%81></a></h1><p>　　redis默认开启了保护模式，只允许本地回环地址登录并访问数据库。<br>禁止protected-mode<br>protected-mode yes/no （保护模式，是否只允许本地访问）<br>(1)Bind :指定IP进行监听</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@db01 ~<span style=color:#f92672>]</span><span style=color:#75715e># vim /opt/redis_cluster/redis_6379/conf/redis_6379.conf</span>
</span></span><span style=display:flex><span>bind 10.0.0.51  127.0.0.1
</span></span></code></pre></div><p>　　(2)增加requirepass {password}</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> vim /opt/redis_cluster/redis_6379/conf/redis_6379.conf
</span></span><span style=display:flex><span>requirepass <span style=color:#ae81ff>123456</span>
</span></span></code></pre></div><p>　　验证方法一：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>redis-cli</span> <span style=color:#f92672>-a</span> <span style=color:#f92672>123456</span>
</span></span><span style=display:flex><span><span style=color:#f92672>127</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>1</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>set</span> <span style=color:#f92672>k1</span> <span style=color:#f92672>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span></code></pre></div><p>　　验证方法二：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>redis-cli</span>
</span></span><span style=display:flex><span><span style=color:#f92672>127</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>1</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>auth</span> <span style=color:#f92672>123456</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>127</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>1</span>:<span style=color:#a6e22e>6379</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>set</span> <span style=color:#f92672>k2</span> <span style=color:#f92672>v2</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span></code></pre></div><h1 id=第6章-redis主从复制>第6章 Redis主从复制
<a class=header-anchor href=#%e7%ac%ac6%e7%ab%a0-redis%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6></a></h1><h2 id=61-主从复制介绍>6.1 主从复制介绍
<a class=header-anchor href=#61-%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6%e4%bb%8b%e7%bb%8d></a></h2><p>　　主从复制介绍<br>在分布式系统中为了解决单点问题,通常会把数据复制多个副本到其他机器,满足故障恢复和负载均衡等求.<br>Redis也是如此,提供了复制功能.<br>复制功能是高可用Redis的基础,后面的哨兵和集群都是在复制的基础上实现高可用的.</p><h2 id=62-配置命令>6.2 配置命令
<a class=header-anchor href=#62-%e9%85%8d%e7%bd%ae%e5%91%bd%e4%bb%a4></a></h2><h3 id=621-建立复制>6.2.1 建立复制
<a class=header-anchor href=#621-%e5%bb%ba%e7%ab%8b%e5%a4%8d%e5%88%b6></a></h3><p>　　每个从节点只能有一个主节点,主节点可以有多个从节点.<br>配置复制的方式有三种:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>.</span><span style=color:#960050;background-color:#1e0010>在配置文件中加入</span>slaveof {masterHost} {masterPort} <span style=color:#960050;background-color:#1e0010>随</span>redis启动生效<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span><span style=color:#f92672>.</span><span style=color:#960050;background-color:#1e0010>在</span>redis<span style=color:#f92672>-</span>server启动命令后加入<span style=color:#960050;background-color:#1e0010>—</span>slaveof {masterHost} {masterPort}<span style=color:#960050;background-color:#1e0010>生效</span><span style=color:#f92672>.</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span><span style=color:#f92672>.</span><span style=color:#960050;background-color:#1e0010>直接使用命令</span><span style=color:#e6db74>:slaveof</span> {masterHost} {masterPort}<span style=color:#960050;background-color:#1e0010>生效</span><span style=color:#f92672>.</span>
</span></span></code></pre></div><p>　　查看复制状态信息命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>Info replication
</span></span></code></pre></div><h3 id=622-断开复制>6.2.2 断开复制
<a class=header-anchor href=#622-%e6%96%ad%e5%bc%80%e5%a4%8d%e5%88%b6></a></h3><p>　　Slaveof命令不但可以建立复制,还可以在从节点执行slave of no one来断开与主节点复制关系.<br>断开复制主要流程:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>1.断开与主节点复制关系
</span></span><span style=display:flex><span>2.从节点晋升为主节点
</span></span></code></pre></div><p>　　从节点断开复制后不会抛弃原有数据,只是无法再获取主节点上的数据变化.<br>通过slaveof命令还可以实现切主操作,所谓切主是指把当前从节点对主节点的复制切换到另一个主节点.<br>执行slaveof {newMasterIp} {newMasterPort}命令即可.<br>切主操作流程如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>1.断开与旧主节点的复制关系
</span></span><span style=display:flex><span>2.与新主节点建立复制关系
</span></span><span style=display:flex><span>3.删除从节点当前所有数据
</span></span><span style=display:flex><span>4.对新主节点进行复制操作
</span></span></code></pre></div><p>　　提示: 线上操作一定要小心,因为切主后会清空之前所有的数据.</p><h1 id=第7章-redis-sentinel哨兵>第7章 Redis Sentinel（哨兵）
<a class=header-anchor href=#%e7%ac%ac7%e7%ab%a0-redis-sentinel%e5%93%a8%e5%85%b5></a></h1><h2 id=71-哨兵介绍>7.1 哨兵介绍
<a class=header-anchor href=#71-%e5%93%a8%e5%85%b5%e4%bb%8b%e7%bb%8d></a></h2><p>　　Sentinel介绍<br>Redis的主从模式下，主节点一旦发生故障不能提供服务，需要人工干预，将从节点晋升为主节点，同时还需要修改客户端配置。对于很多应用场景这种方式无法接受。<br>Sentinel（哨兵）架构解决了redis主从人工干预的问题。<br>Redis Sentinel是redis的高可用实现方案，实际生产环境中，对提高整个系统可用性非常有帮助的。</p><h2 id=72-哨兵主要功能>7.2 哨兵主要功能
<a class=header-anchor href=#72-%e5%93%a8%e5%85%b5%e4%b8%bb%e8%a6%81%e5%8a%9f%e8%83%bd></a></h2><p>　　Redis Sentinel 是一个分布式系统， Redis Sentinel为Redis提供高可用性。可以在没有人为干预的情况下阻止某种类型的故障。<br>Redis 的 Sentinel 系统用于管理多个 Redis 服务器（instance）该系统执行以下三个任务：<br>1.监控（Monitoring）：<br>Sentinel 会不断地定期检查你的主服务器和从服务器是否运作正常。<br>2.提醒（Notification）：<br>当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。<br>3.自动故障迁移（Automatic failover）：<br>当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器<br>架构图：</p><h2 id=73-目录规划>7.3 目录规划
<a class=header-anchor href=#73-%e7%9b%ae%e5%bd%95%e8%a7%84%e5%88%92></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>角色</span>  <span style=color:#f92672>IP</span>  <span style=color:#f92672>端口</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Master</span>  <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>   <span style=color:#f92672>6379</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Sentinel-01</span>     <span style=color:#f92672>26379</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Master</span>  <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span>   <span style=color:#f92672>6379</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Sentinel-01</span>     <span style=color:#f92672>26379</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Master</span>  <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span>   <span style=color:#f92672>6379</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Sentinel-01</span>     <span style=color:#f92672>26379</span>
</span></span></code></pre></div><h2 id=74-安装配置命令>7.4 安装配置命令
<a class=header-anchor href=#74-%e5%ae%89%e8%a3%85%e9%85%8d%e7%bd%ae%e5%91%bd%e4%bb%a4></a></h2><p>　　哨兵是基于主从复制，所以需要先部署好主从复制<br>手工操作步骤如下：<br>1.先配置和创建好1台服务器的节点和哨兵<br>2.使用rsync传输到另外2台机器<br>3.修改另外两台机器的IP地址<br>建议使用ansible剧本批量部署</p><h3 id=741-db01命令>7.4.1 db01命令
<a class=header-anchor href=#741-db01%e5%91%bd%e4%bb%a4></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>mkdir -p /<span style=color:#66d9ef>data</span>/redis_cluster/redis_26379
</span></span><span style=display:flex><span>mkdir -p /opt/redis_cluster/redis_26379/{conf,pid,logs}
</span></span><span style=display:flex><span>vim /opt/redis_cluster/redis_26379/conf/redis_26379.conf
</span></span><span style=display:flex><span>bind <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.51</span>
</span></span><span style=display:flex><span>port <span style=color:#ae81ff>26379</span>
</span></span><span style=display:flex><span>daemonize yes
</span></span><span style=display:flex><span>logfile /opt/redis_cluster/redis_26379/logs/redis_26379.log
</span></span><span style=display:flex><span>dir /<span style=color:#66d9ef>data</span>/redis_cluster/redis_26379
</span></span><span style=display:flex><span>sentinel monitor mymaster <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.51</span> <span style=color:#ae81ff>6379</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>sentinel down-after-milliseconds mymaster <span style=color:#ae81ff>3000</span>
</span></span><span style=display:flex><span>sentinel parallel-syncs mymaster <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>sentinel failover-timeout mymaster <span style=color:#ae81ff>18000</span>
</span></span></code></pre></div><h3 id=742-配置文件解释>7.4.2 配置文件解释
<a class=header-anchor href=#742-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%a7%a3%e9%87%8a></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sentinel monitor mymaster 10.0.0.51 <span style=color:#ae81ff>6379</span> <span style=color:#ae81ff>2</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#mymaster主节点别名 主节点 ip 和端口，判断主节点失败，两个 sentinel 节点同意</span>
</span></span><span style=display:flex><span>sentinel down-after-milliseconds mymaster <span style=color:#ae81ff>30000</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#选项指定了 Sentinel 认为服务器已经断线所需的毫秒数。</span>
</span></span><span style=display:flex><span>sentinel parallel-syncs mymaster <span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#向新的主节点发起复制操作的从节点个数，1轮询发起复制</span>
</span></span><span style=display:flex><span>sentinel failover-timeout mymaster <span style=color:#ae81ff>180000</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#故障转移超时时间</span>
</span></span></code></pre></div><h3 id=743-db02db03命令>7.4.3 db02/db03命令
<a class=header-anchor href=#743-db02db03%e5%91%bd%e4%bb%a4></a></h3><p>　　db01</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>rsync -avz /opt/* db02:/opt/
</span></span><span style=display:flex><span>rsync -avz /opt/* db03:/opt/
</span></span></code></pre></div><p>　　db02</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /data/redis_cluster/redis_26379
</span></span><span style=display:flex><span>cd /opt/redis_cluster/redis
</span></span><span style=display:flex><span>make install
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#bind 10.0.0.51#bind 10.0.0.52#g&#39;</span> /opt/redis_cluster/redis_6379/conf/redis_6379.conf
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#bind 10.0.0.51#bind 10.0.0.52#g&#39;</span> /opt/redis_cluster/redis_26379/conf/redis_26379.conf
</span></span></code></pre></div><p>　　db03</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /data/redis_cluster/redis_26379
</span></span><span style=display:flex><span>cd /opt/redis_cluster/redis
</span></span><span style=display:flex><span>make install
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#bind 10.0.0.51#bind 10.0.0.53#g&#39;</span> /opt/redis_cluster/redis_6379/conf/redis_6379.conf
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#bind 10.0.0.51#bind 10.0.0.53#g&#39;</span> /opt/redis_cluster/redis_26379/conf/redis_26379.conf
</span></span></code></pre></div><h3 id=744-配置主从关系>7.4.4 配置主从关系
<a class=header-anchor href=#744-%e9%85%8d%e7%bd%ae%e4%b8%bb%e4%bb%8e%e5%85%b3%e7%b3%bb></a></h3><p>　　db02和db03</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-server /opt/redis_cluster/redis_6379/conf/redis_6379.conf
</span></span><span style=display:flex><span>redis-cli slaveof 10.0.0.51 6379
</span></span><span style=display:flex><span>ps -ef|grep redis
</span></span></code></pre></div><h3 id=745-启动哨兵>7.4.5 启动哨兵
<a class=header-anchor href=#745-%e5%90%af%e5%8a%a8%e5%93%a8%e5%85%b5></a></h3><p>　　3台都操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-sentinel /opt/redis_cluster/redis_26379/conf/redis_26379.conf
</span></span></code></pre></div><h2 id=75-配置文件的变化>7.5 配置文件的变化
<a class=header-anchor href=#75-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%9a%84%e5%8f%98%e5%8c%96></a></h2><p>　　当所有节点启动后,配置文件的内容发生了变化,体现在三个方面:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>1)Sentinel节点自动发现了从节点,其余Sentinel节点
</span></span><span style=display:flex><span>2)去掉了默认配置,例如parallel-syncs failover-timeout参数
</span></span><span style=display:flex><span>3)添加了配置纪元相关参数
</span></span></code></pre></div><p>　　查看配置文件命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> tail -<span style=color:#ae81ff>6</span> /opt/redis_cluster/redis_26379/conf/redis_26379.conf  
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>#</span> Generated <span style=color:#66d9ef>by</span> CONFIG REWRITE
</span></span><span style=display:flex><span>sentinel known-slave mymaster <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.52</span> <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>sentinel known-slave mymaster <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.53</span> <span style=color:#ae81ff>6379</span>
</span></span><span style=display:flex><span>sentinel known-sentinel mymaster <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.53</span> <span style=color:#ae81ff>26379</span> <span style=color:#ae81ff>7794f</span>bbb9dfb62f4d2d7f06ddef06bacb62e4c97
</span></span><span style=display:flex><span>sentinel known-sentinel mymaster <span style=color:#ae81ff>10.0</span>.<span style=color:#ae81ff>0.52</span> <span style=color:#ae81ff>26379</span> <span style=color:#ae81ff>17</span>bfab23bc53a531571790b9b31558dddeaeca40
</span></span><span style=display:flex><span>sentinel current-epoch <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=76-哨兵常用操作api>7.6 哨兵常用操作API
<a class=header-anchor href=#76-%e5%93%a8%e5%85%b5%e5%b8%b8%e7%94%a8%e6%93%8d%e4%bd%9capi></a></h2><p>　　登陆命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span>[root@db01 ~]# redis-cli -h db01 -p 26379
</span></span><span style=display:flex><span>Sentinel节点是一个特殊的Redis节点,他们有自己专属的API
</span></span><span style=display:flex><span>Info Sentinel
</span></span><span style=display:flex><span>Sentinel masters
</span></span><span style=display:flex><span>Sentinel master <span style=color:#f92672>&lt;master</span> <span style=color:#960050;background-color:#1e0010>name</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>Sentinel slaves <span style=color:#f92672>&lt;master</span> <span style=color:#960050;background-color:#1e0010>name</span><span style=color:#f92672>&gt;</span> 
</span></span><span style=display:flex><span>Sentinel sentinels <span style=color:#f92672>&lt;master</span> <span style=color:#960050;background-color:#1e0010>name</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>Sentinel get-master-addr-by-name <span style=color:#f92672>&lt;master</span> <span style=color:#960050;background-color:#1e0010>name</span><span style=color:#f92672>&gt;</span>   
</span></span><span style=display:flex><span>Sentinel failover <span style=color:#f92672>&lt;master</span> <span style=color:#960050;background-color:#1e0010>name</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>Sentinel flushconfig
</span></span></code></pre></div><h2 id=77-模拟故障转移>7.7 模拟故障转移
<a class=header-anchor href=#77-%e6%a8%a1%e6%8b%9f%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb></a></h2><p>　　停掉其中1个节点，然后观察其他节点的日志变化<br>故障转移后配置文件变化<br>Redis Sentinel存在多个从节点时,如果想将指定的从节点晋升为主节点,可以将其他从节点的slavepriority配置为0,但是需要注意failover后,将slave-priority调回原值.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>1</span>.<span style=color:#a6e22e>查询命令</span>:<span style=color:#a6e22e>CONFIG</span> <span style=color:#f92672>GET</span> <span style=color:#f92672>slave-priority</span>
</span></span><span style=display:flex><span><span style=color:#f92672>2</span>.<span style=color:#a6e22e>设置命令</span>:<span style=color:#a6e22e>CONFIG</span> <span style=color:#f92672>SET</span> <span style=color:#f92672>slave-priority</span> <span style=color:#f92672>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>3</span>.<span style=color:#a6e22e>主动切换</span>:<span style=color:#a6e22e>sentinel</span> <span style=color:#f92672>failover</span> <span style=color:#f92672>mymaster</span>
</span></span></code></pre></div><p>　　操作过程：<br>db02/db03操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-cli -h db02 -p 6379 CONFIG SET slave-priority 0
</span></span><span style=display:flex><span>redis-cli -h db03 -p 6379 CONFIG SET slave-priority 0
</span></span></code></pre></div><p>　　db01操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>redis-cli -h db01 -p 26379 Sentinel failover mymaster
</span></span></code></pre></div><h1 id=第8章-redis-cluster>第8章 Redis Cluster
<a class=header-anchor href=#%e7%ac%ac8%e7%ab%a0-redis-cluster></a></h1><h2 id=81-集群介绍>8.1 集群介绍
<a class=header-anchor href=#81-%e9%9b%86%e7%be%a4%e4%bb%8b%e7%bb%8d></a></h2><p>　　Redis Cluster 是 redis的分布式解决方案，在3.0版本正式推出<br>当遇到单机、内存、并发、流量等瓶颈时，可以采用Cluster架构方案达到负载均衡目的。<br>Redis Cluster之前的分布式方案有两种：<br>1)客户端分区方案，优点分区逻辑可控，缺点是需要自己处理数据路由，高可用和故障转移等。</p><ol start=2><li>代理方案，优点是简化客户端分布式逻辑和升级维护便利，缺点加重架构部署和性能消耗。<br>官方提供的 Redis Cluster集群方案，很好的解决了集群方面的问题</li></ol><h2 id=82-数据分布>8.2 数据分布
<a class=header-anchor href=#82-%e6%95%b0%e6%8d%ae%e5%88%86%e5%b8%83></a></h2><p>　　分布式数据库首先要解决把整个数据库集按照分区规则映射到多个节点的问题，即把数据集划分到多个节点上，每个节点负责整体数据的一个子集，需要关注的是数据分片规则，Redis Cluster采用哈希分片规则。</p><h2 id=83-目录规划>8.3 目录规划
<a class=header-anchor href=#83-%e7%9b%ae%e5%bd%95%e8%a7%84%e5%88%92></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># redis安装目录</span>
</span></span><span style=display:flex><span>/opt/redis_cluster/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>conf,logs,pid<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># redis数据目录</span>
</span></span><span style=display:flex><span>/data/redis_cluster/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>/redis_<span style=color:#f92672>{</span>PORT<span style=color:#f92672>}</span>.rdb
</span></span><span style=display:flex><span><span style=color:#75715e># redis运维脚本</span>
</span></span><span style=display:flex><span>/root/scripts/redis_shell.sh
</span></span></code></pre></div><h2 id=84-集群拓扑>8.4 集群拓扑
<a class=header-anchor href=#84-%e9%9b%86%e7%be%a4%e6%8b%93%e6%89%91></a></h2><p>　　不太合理的拓扑：</p><p>　　合理的拓扑：</p><h2 id=85-手动搭建部署集群>8.5 手动搭建部署集群
<a class=header-anchor href=#85-%e6%89%8b%e5%8a%a8%e6%90%ad%e5%bb%ba%e9%83%a8%e7%bd%b2%e9%9b%86%e7%be%a4></a></h2><p>　　思路:<br>1)部署一台服务器上的2个集群节点<br>2)发送完成后修改其他主机的IP地址<br>3)使用ansible批量部署<br>实现命令：<br>db01操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#a6e22e>mkdir</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>p</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_</span>{<span style=color:#ae81ff>6380</span>,<span style=color:#ae81ff>6381</span>}<span style=color:#f92672>/</span>{<span style=color:#a6e22e>conf</span>,<span style=color:#a6e22e>logs</span>,<span style=color:#a6e22e>pid</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>mkdir</span> <span style=color:#960050;background-color:#1e0010>–</span><span style=color:#a6e22e>p</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>data</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_</span>{<span style=color:#ae81ff>6380</span>,<span style=color:#ae81ff>6381</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>cat</span> <span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>/opt/redis_cluster/redis_6380/conf/redis_6380.conf&lt;&lt;EOF</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>bind</span> <span style=color:#ae81ff>10.0.0.51</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>port</span> <span style=color:#ae81ff>6380</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>daemonize</span> <span style=color:#a6e22e>yes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>pidfile</span> <span style=color:#e6db74>&#34;/opt/redis_cluster/redis_6380/pid/redis_6380.pid&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logfile</span> <span style=color:#e6db74>&#34;/opt/redis_cluster/redis_6380/logs/redis_6380.log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dbfilename</span> <span style=color:#e6db74>&#34;redis_6380.rdb&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dir</span> <span style=color:#e6db74>&#34;/data/redis_cluster/redis_6380/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cluster</span><span style=color:#f92672>-</span><span style=color:#a6e22e>enabled</span> <span style=color:#a6e22e>yes</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cluster</span><span style=color:#f92672>-</span><span style=color:#a6e22e>config</span><span style=color:#f92672>-</span><span style=color:#a6e22e>file</span> <span style=color:#a6e22e>nodes_6380</span>.<span style=color:#a6e22e>conf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cluster</span><span style=color:#f92672>-</span><span style=color:#a6e22e>node</span><span style=color:#f92672>-</span><span style=color:#a6e22e>timeout</span> <span style=color:#ae81ff>15000</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>EOF</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cd</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>redis_6380</span><span style=color:#f92672>/</span><span style=color:#a6e22e>conf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6380</span>.<span style=color:#a6e22e>conf</span> <span style=color:#a6e22e>redis_6381</span><span style=color:#f92672>/</span><span style=color:#a6e22e>conf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6381</span>.<span style=color:#a6e22e>conf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sed</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>i</span> <span style=color:#e6db74>&#39;s#6380#6381#g&#39;</span> <span style=color:#a6e22e>redis_6381</span><span style=color:#f92672>/</span><span style=color:#a6e22e>conf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6381</span>.<span style=color:#a6e22e>conf</span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsync</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>avz</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_638</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>db02</span><span style=color:#f92672>:</span><span style=color:#960050;background-color:#1e0010>/opt/redis_cluster/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rsync</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>avz</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_638</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>db03</span><span style=color:#f92672>:</span><span style=color:#960050;background-color:#1e0010>/opt/redis_cluster/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>redis</span><span style=color:#f92672>-</span><span style=color:#a6e22e>server</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6380</span><span style=color:#f92672>/</span><span style=color:#a6e22e>conf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6380</span>.<span style=color:#a6e22e>conf</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>redis</span><span style=color:#f92672>-</span><span style=color:#a6e22e>server</span> <span style=color:#f92672>/</span><span style=color:#a6e22e>opt</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_cluster</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6381</span><span style=color:#f92672>/</span><span style=color:#a6e22e>conf</span><span style=color:#f92672>/</span><span style=color:#a6e22e>redis_6381</span>.<span style=color:#a6e22e>conf</span>
</span></span></code></pre></div><p>　　db02操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span>find <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_638<span style=color:#f92672>*</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>f</span> <span style=color:#f92672>-</span>name <span style=color:#e6db74>&#34;*.conf&#34;</span><span style=color:#f92672>|</span>xargs sed <span style=color:#f92672>-</span>i <span style=color:#e6db74>&#34;/bind/s#51#52#g&#34;</span>
</span></span><span style=display:flex><span>mkdir <span style=color:#960050;background-color:#1e0010>–</span>p <span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_{<span style=color:#ae81ff>6380</span>,<span style=color:#ae81ff>6381</span>}
</span></span><span style=display:flex><span>redis<span style=color:#f92672>-</span>server <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_6380<span style=color:#f92672>/</span>conf<span style=color:#f92672>/</span>redis_6380.conf
</span></span><span style=display:flex><span>redis<span style=color:#f92672>-</span>server <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_6381<span style=color:#f92672>/</span>conf<span style=color:#f92672>/</span>redis_6381.conf
</span></span></code></pre></div><p>　　db03操作</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span>find <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_638<span style=color:#f92672>*</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>f</span> <span style=color:#f92672>-</span>name <span style=color:#e6db74>&#34;*.conf&#34;</span><span style=color:#f92672>|</span>xargs sed <span style=color:#f92672>-</span>i <span style=color:#e6db74>&#34;/bind/s#51#53#g&#34;</span>
</span></span><span style=display:flex><span>mkdir <span style=color:#960050;background-color:#1e0010>–</span>p <span style=color:#f92672>/</span>data<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_{<span style=color:#ae81ff>6380</span>,<span style=color:#ae81ff>6381</span>}
</span></span><span style=display:flex><span>redis<span style=color:#f92672>-</span>server <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_6380<span style=color:#f92672>/</span>conf<span style=color:#f92672>/</span>redis_6380.conf
</span></span><span style=display:flex><span>redis<span style=color:#f92672>-</span>server <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis_6381<span style=color:#f92672>/</span>conf<span style=color:#f92672>/</span>redis_6381.conf
</span></span></code></pre></div><h3 id=851-手动配置节点发现>8.5.1 手动配置节点发现
<a class=header-anchor href=#851-%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%ae%e8%8a%82%e7%82%b9%e5%8f%91%e7%8e%b0></a></h3><p>　　当把所有节点都启动后查看进程会有cluster的字样</p><p>　　但是登录后执行CLUSTER NODES命令会发现只有每个节点自己的ID,目前集群内的节点<br>还没有互相发现,所以搭建redis集群我们第一步要做的就是让集群内的节点互相发现.</p><p>　　在执行节点发现命令之前我们先查看一下集群的数据目录会发现有生成集群的配置文件</p><p>　　查看后发现只有自己的节点内容,等节点全部发现后会把所发现的节点ID写入这个文件</p><p>　　集群模式的Redis除了原有的配置文件之外又加了一份集群配置文件.当集群内节点<br>信息发生变化,如添加节点,节点下线,故障转移等.节点会自动保存集群状态到配置文件.<br>需要注意的是,Redis自动维护集群配置文件,不需要手动修改,防止节点重启时产生错乱.</p><p>　　节点发现使用命令: CLUSTER MEET {IP} {PORT}<br>提示:在集群内任意一台机器执行此命令就可以</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>sh</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>login</span> <span style=color:#f92672>6380</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>MEET</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span> <span style=color:#f92672>6381</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>MEET</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span> <span style=color:#f92672>6380</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>MEET</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span> <span style=color:#f92672>6380</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>MEET</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span> <span style=color:#f92672>6381</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>MEET</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span> <span style=color:#f92672>6381</span>
</span></span><span style=display:flex><span><span style=color:#f92672>OK</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>NODES</span>
</span></span><span style=display:flex><span><span style=color:#f92672>d03cb38d612802aead8f727b1726a3359c241818</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span> <span style=color:#f92672>myself</span><span style=color:#f92672>,</span><span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>0</span> <span style=color:#f92672>4</span> <span style=color:#f92672>connected</span>
</span></span><span style=display:flex><span><span style=color:#f92672>67c8128df00b2fa304a41bafbadac25a654f196d</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6381</span> <span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>1562059947079</span> <span style=color:#f92672>1</span> <span style=color:#f92672>connected</span>
</span></span><span style=display:flex><span><span style=color:#f92672>a23ec7d444791a0b258ac454ef15cb4d6ab5abd2</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span>:<span style=color:#a6e22e>6381</span> <span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>1562059948087</span> <span style=color:#f92672>5</span> <span style=color:#f92672>connected</span>
</span></span><span style=display:flex><span><span style=color:#f92672>e57807d4d35daaaca05f4a9705e844eab15c7ce8</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span>:<span style=color:#a6e22e>6381</span> <span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>1562059949098</span> <span style=color:#f92672>0</span> <span style=color:#f92672>connected</span>
</span></span><span style=display:flex><span><span style=color:#f92672>aa9da67a594dfb357195f12ca4c44001804ee470</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span>:<span style=color:#a6e22e>6380</span> <span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>1562059945063</span> <span style=color:#f92672>3</span> <span style=color:#f92672>connected</span>
</span></span><span style=display:flex><span><span style=color:#f92672>5cb6895305520e6a0aa4198a6ea5f2c087530b41</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span>:<span style=color:#a6e22e>6380</span> <span style=color:#f92672>master</span> <span style=color:#f92672>-</span> <span style=color:#f92672>0</span> <span style=color:#f92672>1562059950108</span> <span style=color:#f92672>2</span> <span style=color:#f92672>connected</span>
</span></span></code></pre></div><p>　　节点都发现完毕后我们再次查看集群配置文件<br>可以看到,发现到的节点的ID也被写入到了集群的配置文件里</p><h3 id=852-redis-cluster-通讯流程>8.5.2 Redis Cluster 通讯流程
<a class=header-anchor href=#852-redis-cluster-%e9%80%9a%e8%ae%af%e6%b5%81%e7%a8%8b></a></h3><p>　　在分布式存储中需要提供维护节点元数据信息的机制，所谓元数据是指：节点负责哪些数据，是否出现故障灯状态信息，redis 集群采用 Gossip(流言)协议，Gossip 协议工作原理就是节点彼此不断交换信息，一段时间后所有的节点都会知道集群完整信息，这种方式类似流言传播。<br>通信过程：<br>1)集群中的每一个节点都会单独开辟一个 Tcp 通道，用于节点之间彼此通信，通信端口在基础端口上家10000.<br>2)每个节点在固定周期内通过特定规则选择结构节点发送 ping 消息<br>3)接收到 ping 消息的节点用 pong 消息作为响应。集群中每个节点通过一定规则挑选要通信的节点，每个节点可能知道全部节点，也可能仅知道部分节点，只要这些节点彼此可以正常通信，最终他们会打成一致的状态，当节点出现故障，新节点加入，主从角色变化等，它能够给不断的ping/pong消息，从而达到同步目的。<br>通讯消息类型：<br>Gossip<br>Gossip 协议职责就是信息交换，信息交换的载体就是节点间彼此发送Gossip 消息。<br>常见 Gossip 消息分为：ping、 pong、 meet、 fail 等<br>meet<br>meet 消息：用于通知新节点加入，消息发送者通知接受者加入到当前集群，meet 消息通信正常完成后，接收节点会加入到集群中并进行ping、 pong 消息交换<br>ping<br>ping 消息：集群内交换最频繁的消息，集群内每个节点每秒想多个其他节点发送 ping 消息，用于检测节点是否在线和交换彼此信息。<br>pong<br>Pong 消息：当接收到 ping，meet 消息时，作为相应消息回复给发送方确认消息正常通信，节点也可以向集群内广播自身的 pong 消息来通知整个集群对自身状态进行更新。<br>fail<br>fail 消息：当节点判定集群内另一个节点下线时，回向集群内广播一个fail 消息，其他节点收到 fail 消息之后把对应节点更新为下线状态。<br>通讯示意图：</p><h3 id=853-redis-cluster手动分配槽位>8.5.3 Redis Cluster手动分配槽位
<a class=header-anchor href=#853-redis-cluster%e6%89%8b%e5%8a%a8%e5%88%86%e9%85%8d%e6%a7%bd%e4%bd%8d></a></h3><p>　　虽然节点之间已经互相发现了,但是此时集群还是不可用的状态,因为并没有给节点分配槽位,而且必须是所有的槽位都分配完毕后整个集群才是可用的状态.<br>反之,也就是说只要有一个槽位没有分配,那么整个集群就是不可用的.<br>测试命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>sh</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>login</span> <span style=color:#f92672>6380</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>set</span> <span style=color:#f92672>k1</span> <span style=color:#f92672>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>error</span><span style=color:#f92672>)</span> <span style=color:#f92672>CLUSTERDOWN</span> <span style=color:#f92672>Hash</span> <span style=color:#f92672>slot</span> <span style=color:#f92672>not</span> <span style=color:#f92672>served</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>CLUSTER</span> <span style=color:#f92672>INFO</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_state</span>:<span style=color:#a6e22e>fail</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_slots_assigned</span>:<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_slots_ok</span>:<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_slots_pfail</span>:<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_slots_fail</span>:<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_known_nodes</span>:<span style=color:#a6e22e>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_size</span>:<span style=color:#a6e22e>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_current_epoch</span>:<span style=color:#a6e22e>5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_my_epoch</span>:<span style=color:#a6e22e>4</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_stats_messages_sent</span>:<span style=color:#a6e22e>1200</span>
</span></span><span style=display:flex><span><span style=color:#f92672>cluster_stats_messages_received</span>:<span style=color:#a6e22e>1200</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>　　前面说了,我们虽然有6个节点,但是真正负责数据写入的只有3个节点,其他3个节点只是作为主节点的从节点,也就是说,只需要分配期中三个节点的槽位就可以了<br>分配槽位的方法:<br>分配槽位需要在每个主节点上来配置,此时有2种方法执行:<br>1.分别登录到每个主节点的客户端来执行命令<br>2.在其中一台机器上用redis客户端远程登录到其他机器的主节点上执行命令<br>每个节点执行命令:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db01 -p <span style=color:#ae81ff>6380</span> cluster addslots {<span style=color:#ae81ff>0.</span>.<span style=color:#ae81ff>5461</span>}
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db02 -p <span style=color:#ae81ff>6380</span> cluster addslots {<span style=color:#ae81ff>5462.</span>.<span style=color:#ae81ff>10922</span>}
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db03 -p <span style=color:#ae81ff>6380</span> cluster addslots {<span style=color:#ae81ff>10923.</span>.<span style=color:#ae81ff>16383</span>}
</span></span><span style=display:flex><span>OK
</span></span></code></pre></div><p>　　分配完所有槽位之后我们再查看一下集群的节点状态和集群状态<br>可以看到三个节点都分配了槽位,而且集群的状态是OK的</p><h3 id=854-手动配置集群高可用>8.5.4 手动配置集群高可用
<a class=header-anchor href=#854-%e6%89%8b%e5%8a%a8%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4%e9%ab%98%e5%8f%af%e7%94%a8></a></h3><p>　　虽然这时候集群是可用的了,但是整个集群只要有一台机器坏掉了,那么整个集群都是不可用的.<br>所以这时候需要用到其他三个节点分别作为现在三个主节点的从节点,以应对集群主节点故障时可以进行自动切换以保证集群持续可用.<br>注意:<br>1.不要让复制节点复制本机器的主节点, 因为如果那样的话机器挂了集群还是不可用状态, 所以复制节点要复制其他服务器的主节点.<br>2.使用redis-trid工具自动分配的时候会出现复制节点和主节点在同一台机器上的情况,需要注意</p><h3 id=855-测试集群>8.5.5 测试集群
<a class=header-anchor href=#855-%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4></a></h3><p>　　这一次我们采用在一台机器上使用redis客户端远程操作集群其他节点<br>注意:<br>1.需要执行命令的是每个服务器的从节点<br>2.注意主从的ID不要搞混了.<br>执行命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db01 -p <span style=color:#ae81ff>6381</span> CLUSTER REPLICATE <span style=color:#ae81ff>5</span>cb6895305520e6a0aa4198a6ea5f2c087530b41
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db02 -p <span style=color:#ae81ff>6381</span> CLUSTER REPLICATE aa9da67a594dfb357195f12ca4c44001804ee470
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-cli -h db03 -p <span style=color:#ae81ff>6381</span> CLUSTER REPLICATE d03cb38d612802aead8f727b1726a3359c241818
</span></span><span style=display:flex><span>OK
</span></span></code></pre></div><h2 id=86-redis-cluster测试集群>8.6 Redis Cluster测试集群
<a class=header-anchor href=#86-redis-cluster%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4></a></h2><p>　　我们使用常规插入redis数据的方式往集群里写入数据看看会发生什么</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span> <span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>redis-cli</span> <span style=color:#f92672>-h</span> <span style=color:#f92672>db01</span> <span style=color:#f92672>-p</span> <span style=color:#f92672>6380</span> <span style=color:#f92672>set</span> <span style=color:#f92672>k1</span> <span style=color:#f92672>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span><span style=color:#f92672>error</span><span style=color:#f92672>)</span> <span style=color:#f92672>MOVED</span> <span style=color:#f92672>12706</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>53</span>:<span style=color:#a6e22e>6380</span>
</span></span></code></pre></div><p>　　结果提示error, 但是给出了集群另一个节点的地址<br>那么这条数据到底有没有写入呢? 我们登录这两个节点分别查看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#f92672>[</span>root@db01 <span style=color:#f92672>~]</span><span style=color:#75715e># redis-cli -h db03 -p 6380 get k1  </span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>nil</span>)
</span></span></code></pre></div><p>　　结果没有,这是因为使用集群后由于数据被分片了,所以并不是说在那台机器上写入数据就会在哪台机器的节点上写入,集群的数据写入和读取就涉及到了另外一个概念,ASK路由</p><h2 id=87-redis-cluster-ask路由介绍>8.7 Redis Cluster ASK路由介绍
<a class=header-anchor href=#87-redis-cluster-ask%e8%b7%af%e7%94%b1%e4%bb%8b%e7%bb%8d></a></h2><p>　　在集群模式下,Redis接受任何键相关命令时首先会计算键对应的槽,再根据槽找出所对应的节点<br>如果节点是自身,则处理键命令;<br>否则回复MOVED重定向错误,通知客户端请求正确的节点,这个过程称为Mover重定向.</p><p>　　知道了ask路由后,我们使用-c选项批量插入一些数据</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@db01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat input_key.sh </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> 1000<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    redis-cli -c -h db01 -p <span style=color:#ae81ff>6380</span> set k_<span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span> v_<span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;set k_</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> is ok&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>　　写入后我们同样使用-c选项来读取刚才插入的键值,然后查看下redis会不会帮我们路由到正确的节点上</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>redis-cli</span> <span style=color:#f92672>-c</span> <span style=color:#f92672>-h</span> <span style=color:#f92672>db01</span> <span style=color:#f92672>-p</span> <span style=color:#f92672>6380</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>get</span> <span style=color:#f92672>k_1</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;v_1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db01</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>get</span> <span style=color:#f92672>k_100</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>Redirected</span> <span style=color:#f92672>to</span> <span style=color:#f92672>slot</span> <span style=color:#f92672>[</span><span style=color:#f92672>5541</span><span style=color:#f92672>]</span> <span style=color:#f92672>located</span> <span style=color:#f92672>at</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span>:<span style=color:#a6e22e>6380</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;v_100&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>52</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>get</span> <span style=color:#f92672>k_1000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span><span style=color:#f92672>&gt;</span> <span style=color:#f92672>Redirected</span> <span style=color:#f92672>to</span> <span style=color:#f92672>slot</span> <span style=color:#f92672>[</span><span style=color:#f92672>79</span><span style=color:#f92672>]</span> <span style=color:#f92672>located</span> <span style=color:#f92672>at</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;v_1000&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><h2 id=88-模拟故障转移>8.8 模拟故障转移
<a class=header-anchor href=#88-%e6%a8%a1%e6%8b%9f%e6%95%85%e9%9a%9c%e8%bd%ac%e7%a7%bb></a></h2><p>　　至此,我们已经手动的把一个redis高可用的集群部署完毕了, 但是还没有模拟过故障<br>这里我们就模拟故障,停掉期中一台主机的redis节点,然后查看一下集群的变化<br>我们使用暴力的kill -9杀掉 db02上的redis集群节点,然后观察节点状态<br>理想情况应该是db01上的6381从节点升级为主节点</p><p>　　在db01上查看集群节点状态</p><p>　　虽然我们已经测试了故障切换的功能,但是节点修复后还是需要重新上线<br>所以这里测试节点重新上线后的操作<br>重新启动db02的6380,然后观察日志</p><p>　　观察db01上的日志</p><p>　　这时假如我们想让修复后的节点重新上线,可以在想变成主库的从库执行CLUSTER FAILOVER命令<br>这里我们在db02的6380上执行</p><h2 id=89-使用工具搭建部署redis-cluster>8.9 使用工具搭建部署Redis Cluster
<a class=header-anchor href=#89-%e4%bd%bf%e7%94%a8%e5%b7%a5%e5%85%b7%e6%90%ad%e5%bb%ba%e9%83%a8%e7%bd%b2redis-cluster></a></h2><p>　　手动搭建集群便于理解集群创建的流程和细节，不过手动搭建集群需要很多步骤，当集群节点众多时，必然会加大搭建集群的复杂度和运维成本，因此官方提供了 redis-trib.rb的工具方便我们快速搭建集群。<br>redis-trib.rb是采用 Ruby 实现的 redis 集群管理工具，内部通过 Cluster相关命令帮我们简化集群创建、检查、槽迁移和均衡等常见运维操作，使用前要安装 ruby 依赖环境<br>安装命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span>yum makecache fast
</span></span><span style=display:flex><span>yum install rubygems
</span></span><span style=display:flex><span>gem sources --<span style=color:#66d9ef>remove</span> https:<span style=color:#75715e>//rubygems.org/</span>
</span></span><span style=display:flex><span>gem sources -a http:<span style=color:#75715e>//mirrors.aliyun.com/rubygems/</span>
</span></span><span style=display:flex><span>gem update <span style=color:#960050;background-color:#1e0010>–</span>system
</span></span><span style=display:flex><span>gem install redis -v <span style=color:#ae81ff>3.3</span>.<span style=color:#ae81ff>5</span>
</span></span></code></pre></div><p>　　我们可以停掉所有的节点，然后清空数据，恢复成一个全新的集群，所有机器执行命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>pkill redis
</span></span><span style=display:flex><span>rm -rf /<span style=color:#66d9ef>data</span>/redis_cluster/redis_6380/*
</span></span><span style=display:flex><span>rm -rf /<span style=color:#66d9ef>data</span>/redis_cluster/redis_6381/*
</span></span></code></pre></div><p>　　全部清空之后启动所有的节点，所有机器执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>sh</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>start</span> <span style=color:#f92672>6380</span>
</span></span><span style=display:flex><span><span style=color:#f92672>sh</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>start</span> <span style=color:#f92672>6381</span>
</span></span></code></pre></div><p>　　db01执行创建集群命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/redis_cluster/redis/src/
</span></span><span style=display:flex><span>./redis-trib.rb create --replicas <span style=color:#ae81ff>1</span> 10.0.0.51:6380 10.0.0.52:6380 10.0.0.53:6380 10.0.0.51:6381 10.0.0.52:6381 10.0.0.53:6381
</span></span></code></pre></div><p>　　检查集群完整性</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>./redis-trib.rb check 10.0.0.51:6380
</span></span></code></pre></div><h2 id=810-工具扩容节点>8.10 工具扩容节点
<a class=header-anchor href=#810-%e5%b7%a5%e5%85%b7%e6%89%a9%e5%ae%b9%e8%8a%82%e7%82%b9></a></h2><p>　　Redis集群的扩容操作可分为以下几个步骤<br>1)准备新节点<br>2)加入集群<br>3)迁移槽和数据<br>扩容流程图：</p><p>　　我们在db01上创建2个新节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /opt/redis_cluster/redis_<span style=color:#f92672>{</span>6390,6391<span style=color:#f92672>}</span>/<span style=color:#f92672>{</span>conf,logs,pid<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>mkdir -p /data/redis_cluster/redis_<span style=color:#f92672>{</span>6390,6391<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>cd /opt/redis_cluster/
</span></span><span style=display:flex><span>cp redis_6380/conf/redis_6380.conf redis_6390/conf/redis_6390.conf
</span></span><span style=display:flex><span>cp redis_6380/conf/redis_6380.conf redis_6391/conf/redis_6391.conf
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#6380#6390#g&#39;</span> redis_6390/conf/redis_6390.conf
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s#6380#6391#g&#39;</span> redis_6391/conf/redis_6391.conf
</span></span></code></pre></div><p>　　启动节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>bash</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>start</span> <span style=color:#f92672>6390</span>
</span></span><span style=display:flex><span><span style=color:#f92672>bash</span> <span style=color:#f92672>redis_shell</span>.<span style=color:#a6e22e>sh</span> <span style=color:#f92672>start</span> <span style=color:#f92672>6391</span>
</span></span></code></pre></div><p>　　发现节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>redis-cli</span> <span style=color:#f92672>-c</span> <span style=color:#f92672>-h</span> <span style=color:#f92672>db01</span> <span style=color:#f92672>-p</span> <span style=color:#f92672>6380</span> <span style=color:#f92672>cluster</span> <span style=color:#f92672>meet</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span> <span style=color:#f92672>6390</span>
</span></span><span style=display:flex><span><span style=color:#f92672>redis-cli</span> <span style=color:#f92672>-c</span> <span style=color:#f92672>-h</span> <span style=color:#f92672>db01</span> <span style=color:#f92672>-p</span> <span style=color:#f92672>6380</span> <span style=color:#f92672>cluster</span> <span style=color:#f92672>meet</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span> <span style=color:#f92672>6391</span>
</span></span></code></pre></div><p>　　在db01上使用工具扩容</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/redis_cluster/redis/src/
</span></span><span style=display:flex><span>./redis-trib.rb reshard 10.0.0.51:6380
</span></span></code></pre></div><p>　　打印出进群每个节点信息后,reshard命令需要确认迁移的槽数量,这里我们输入4096个:<br>How many slots do you want to move (from 1 to 16384)? 4096<br>输入6390的节点ID作为目标节点,也就是要扩容的节点,目标节点只能指定一个<br>What is the receiving node ID? xxxxxxxxx<br>之后输入源节点的ID,这里分别输入每个主节点的6380的ID最后输入done,或者直接输入all<br>Source node #1:all<br>迁移完成后命令会自动退出,这时候我们查看一下集群的状态<br>./redis-trib.rb rebalance 10.0.0.51:6380</p><h2 id=811-工具收缩节点>8.11 工具收缩节点
<a class=header-anchor href=#811-%e5%b7%a5%e5%85%b7%e6%94%b6%e7%bc%a9%e8%8a%82%e7%82%b9></a></h2><p>　　流程说明<br>1).首先需要确定下线节点是否有负责的槽,<br>如果是,需要把槽迁移到其他节点,保证节点下线后整个集群槽节点映射的完整性.<br>2).当下线节点不再负责槽或者本身是从节点时,<br>就可以通知集群内其他节点忘记下线节点,当所有的节点忘记该节点后可以正常关闭.</p><p>　　这里我们准备将刚才新添加的节点下线,也就是6390和6391<br>收缩和扩容迁移的方向相反,6390变为源节点,其他节点变为目标节点,源节点把自己负责的4096个槽均匀的迁移到其他节点上,.<br>由于redis-trib..rb reshard命令只能有一个目标节点,因此需要执行3次reshard命令,分别迁移1365,1365,1366个槽.<br>操作命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/redis_cluster/redis/src/
</span></span><span style=display:flex><span>./redis-trib.rb reshard 10.0.0.51:6380
</span></span><span style=display:flex><span>How many slots <span style=color:#66d9ef>do</span> you want to move <span style=color:#f92672>(</span>from <span style=color:#ae81ff>1</span> to 16384<span style=color:#f92672>)</span>? <span style=color:#ae81ff>1365</span>
</span></span><span style=display:flex><span>输入6380的id
</span></span><span style=display:flex><span>输入6390的id
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h2 id=812-忘记节点>8.12 忘记节点
<a class=header-anchor href=#812-%e5%bf%98%e8%ae%b0%e8%8a%82%e7%82%b9></a></h2><p>　　由于我们的集群是做了高可用的,所以当主节点下线的时候从节点也会顶上,所以最好我们先下线从节点,然后在下线主节点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>cd <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>redis_cluster<span style=color:#f92672>/</span>redis<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>
</span></span><span style=display:flex><span><span style=color:#f92672>./</span>redis<span style=color:#f92672>-</span>trib<span style=color:#f92672>.</span>rb <span style=color:#66d9ef>del</span><span style=color:#f92672>-</span>node <span style=color:#ae81ff>10.0.0.51</span>:<span style=color:#ae81ff>6391</span> ID
</span></span><span style=display:flex><span><span style=color:#f92672>./</span>redis<span style=color:#f92672>-</span>trib<span style=color:#f92672>.</span>rb <span style=color:#66d9ef>del</span><span style=color:#f92672>-</span>node <span style=color:#ae81ff>10.0.0.51</span>:<span style=color:#ae81ff>6390</span> ID
</span></span></code></pre></div><h1 id=第9章-redis集群常用命令>第9章 Redis集群常用命令
<a class=header-anchor href=#%e7%ac%ac9%e7%ab%a0-redis%e9%9b%86%e7%be%a4%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4></a></h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-objectivec data-lang=objectivec><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>集群</span>(cluster)
</span></span><span style=display:flex><span>CLUSTER INFO <span style=color:#960050;background-color:#1e0010>打印集群的信息</span>
</span></span><span style=display:flex><span>CLUSTER NODES <span style=color:#960050;background-color:#1e0010>列出集群当前已知的所有节点（</span>node<span style=color:#960050;background-color:#1e0010>），以及这些节点的相关信息。</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>节点</span>(node)
</span></span><span style=display:flex><span>CLUSTER MEET <span style=color:#f92672>&lt;</span>ip<span style=color:#f92672>&gt;</span> <span style=color:#f92672>&lt;</span>port<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>将</span> ip <span style=color:#960050;background-color:#1e0010>和</span> port <span style=color:#960050;background-color:#1e0010>所指定的节点添加到集群当中，让它成为集群的一份子。</span>
</span></span><span style=display:flex><span>CLUSTER FORGET <span style=color:#f92672>&lt;</span>node_id<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>从集群中移除</span> node_id <span style=color:#960050;background-color:#1e0010>指定的节点。</span>
</span></span><span style=display:flex><span>CLUSTER REPLICATE <span style=color:#f92672>&lt;</span>node_id<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>将当前节点设置为</span> node_id <span style=color:#960050;background-color:#1e0010>指定的节点的从节点。</span>
</span></span><span style=display:flex><span>CLUSTER SAVECONFIG <span style=color:#960050;background-color:#1e0010>将节点的配置文件保存到硬盘里面。</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>槽</span>(slot)
</span></span><span style=display:flex><span>CLUSTER ADDSLOTS <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> [slot ...] <span style=color:#960050;background-color:#1e0010>将一个或多个槽（</span>slot<span style=color:#960050;background-color:#1e0010>）指派（</span><span style=color:#66d9ef>assign</span><span style=color:#960050;background-color:#1e0010>）给当前节点。</span>
</span></span><span style=display:flex><span>CLUSTER DELSLOTS <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> [slot ...] <span style=color:#960050;background-color:#1e0010>移除一个或多个槽对当前节点的指派。</span>
</span></span><span style=display:flex><span>CLUSTER FLUSHSLOTS <span style=color:#960050;background-color:#1e0010>移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。</span>
</span></span><span style=display:flex><span>CLUSTER SETSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> NODE <span style=color:#f92672>&lt;</span>node_id<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>将槽</span> slot <span style=color:#960050;background-color:#1e0010>指派给</span> node_id <span style=color:#960050;background-color:#1e0010>指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽</span><span style=color:#f92672>&gt;</span><span style=color:#960050;background-color:#1e0010>，然后再进行指派。</span>
</span></span><span style=display:flex><span>CLUSTER SETSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> MIGRATING <span style=color:#f92672>&lt;</span>node_id<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>将本节点的槽</span> slot <span style=color:#960050;background-color:#1e0010>迁移到</span> node_id <span style=color:#960050;background-color:#1e0010>指定的节点中。</span>
</span></span><span style=display:flex><span>CLUSTER SETSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> IMPORTING <span style=color:#f92672>&lt;</span>node_id<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>从</span> node_id <span style=color:#960050;background-color:#1e0010>指定的节点中导入槽</span> slot <span style=color:#960050;background-color:#1e0010>到本节点。</span>
</span></span><span style=display:flex><span>CLUSTER SETSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> STABLE <span style=color:#960050;background-color:#1e0010>取消对槽</span> slot <span style=color:#960050;background-color:#1e0010>的导入（</span>import<span style=color:#960050;background-color:#1e0010>）或者迁移（</span>migrate<span style=color:#960050;background-color:#1e0010>）。</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>键</span> (key)
</span></span><span style=display:flex><span>CLUSTER KEYSLOT <span style=color:#f92672>&lt;</span>key<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>计算键</span> key <span style=color:#960050;background-color:#1e0010>应该被放置在哪个槽上。</span>
</span></span><span style=display:flex><span>CLUSTER COUNTKEYSINSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>返回槽</span> slot <span style=color:#960050;background-color:#1e0010>目前包含的键值对数量。</span>CLUSTER GETKEYSINSLOT <span style=color:#f92672>&lt;</span>slot<span style=color:#f92672>&gt;</span> <span style=color:#f92672>&lt;</span>count<span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>返回</span> count <span style=color:#960050;background-color:#1e0010>个</span> slot <span style=color:#960050;background-color:#1e0010>槽中的键。</span>
</span></span></code></pre></div><h1 id=第10章-redis运维工具>第10章 Redis运维工具
<a class=header-anchor href=#%e7%ac%ac10%e7%ab%a0-redis%e8%bf%90%e7%bb%b4%e5%b7%a5%e5%85%b7></a></h1><h2 id=101-运维脚本>10.1 运维脚本
<a class=header-anchor href=#101-%e8%bf%90%e7%bb%b4%e8%84%9a%e6%9c%ac></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@db01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat redis_shell.sh </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>USAG<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;sh </span>$0<span style=color:#e6db74> {start|stop|restart|login|ps|tail} PORT&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$#<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    REDIS_PORT<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;6379&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$#<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> -a -z <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>|sed <span style=color:#e6db74>&#39;s#[0-9]##g&#39;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    REDIS_PORT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    USAG
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REDIS_IP<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>hostname -I|awk <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>PATH_DIR<span style=color:#f92672>=</span>/opt/redis_cluster/redis_<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>/
</span></span><span style=display:flex><span>PATH_CONF<span style=color:#f92672>=</span>/opt/redis_cluster/redis_<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>/conf/redis_<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>.conf
</span></span><span style=display:flex><span>PATH_LOG<span style=color:#f92672>=</span>/opt/redis_cluster/redis_<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>/logs/redis_<span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD_START<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    redis-server <span style=color:#e6db74>${</span>PATH_CONF<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD_SHUTDOWN<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    redis-cli -c -h <span style=color:#e6db74>${</span>REDIS_IP<span style=color:#e6db74>}</span> -p <span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span> shutdown
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD_LOGIN<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    redis-cli -c -h <span style=color:#e6db74>${</span>REDIS_IP<span style=color:#e6db74>}</span> -p <span style=color:#e6db74>${</span>REDIS_PORT<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD_PS<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    ps -ef|grep redis
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD_TAIL<span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>    tail -f <span style=color:#e6db74>${</span>PATH_LOG<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> $1 in
</span></span><span style=display:flex><span>    start<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_START
</span></span><span style=display:flex><span>        CMD_PS
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    stop<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_SHUTDOWN
</span></span><span style=display:flex><span>        CMD_PS
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    restart<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_START
</span></span><span style=display:flex><span>        CMD_SHUTDOWN
</span></span><span style=display:flex><span>        CMD_PS
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    login<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_LOGIN
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    ps<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_PS
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    tail<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        CMD_TAIL
</span></span><span style=display:flex><span>        ;;
</span></span><span style=display:flex><span>    *<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        USAG
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span></code></pre></div><h2 id=102-数据导入导出工具>10.2 数据导入导出工具
<a class=header-anchor href=#102-%e6%95%b0%e6%8d%ae%e5%af%bc%e5%85%a5%e5%af%bc%e5%87%ba%e5%b7%a5%e5%85%b7></a></h2><p>　　需求背景<br>刚切换到redis集群的时候肯定会面临数据导入的问题,所以这里推荐使用redis-migrate-tool工具来导入单节点数据到集群里<br>官方地址：<br><a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.oschina.net%2Fp%2Fredis-migrate-tool" title=http://www.oschina.net/p/redis-migrate-tool rel="noopener external nofollow noreferrer" target=_blank class=exturl>http://www.oschina.net/p/redis-migrate-tool
<i class="fa fa-external-link-alt"></i></a><br>安装工具</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/redis_cluster/
</span></span><span style=display:flex><span>git clone https://github.com/vipshop/redis-migrate-tool.git
</span></span><span style=display:flex><span>cd redis-migrate-tool/
</span></span><span style=display:flex><span>autoreconf -fvi
</span></span><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>make <span style=color:#f92672>&amp;&amp;</span> make install 
</span></span></code></pre></div><p>　　创建配置文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-css data-lang=css><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>root</span>@<span style=color:#66d9ef>db01</span> <span style=color:#f92672>~]</span><span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#f92672>cat</span> <span style=color:#f92672>redis_6379_to_6380</span>.<span style=color:#a6e22e>conf</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>source</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>type</span><span style=color:#f92672>:</span> <span style=color:#f92672>single</span>
</span></span><span style=display:flex><span><span style=color:#f92672>servers</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6379</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>target</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>type</span><span style=color:#f92672>:</span> <span style=color:#f92672>redis</span> <span style=color:#f92672>cluster</span>
</span></span><span style=display:flex><span><span style=color:#f92672>servers</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> <span style=color:#f92672>10</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>51</span>:<span style=color:#a6e22e>6380</span> 
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span><span style=color:#f92672>common</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>listen</span><span style=color:#f92672>:</span> <span style=color:#f92672>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>.<span style=color:#a6e22e>0</span>:<span style=color:#a6e22e>8888</span>
</span></span><span style=display:flex><span><span style=color:#f92672>source_safe</span><span style=color:#f92672>:</span> <span style=color:#f92672>true</span>
</span></span></code></pre></div><p>　　生成测试数据</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@db01 ~<span style=color:#f92672>]</span><span style=color:#75715e># cat input_key.sh </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>seq <span style=color:#ae81ff>1</span> 1000<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    redis-cli -c -h db01 -p <span style=color:#ae81ff>6379</span> set k_<span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span> v_<span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;set k_</span><span style=color:#e6db74>${</span>i<span style=color:#e6db74>}</span><span style=color:#e6db74> is ok&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>　　执行导入命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-migrate-tool -c redis_6379_to_6380.conf 
</span></span></code></pre></div><p>　　数据校验</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[root@db01 ~]</span><span style=color:#960050;background-color:#1e0010>#</span> redis-migrate-tool -c redis_6379_to_6380.conf -C redis_check
</span></span></code></pre></div><h2 id=103-分析键值大小>10.3 分析键值大小
<a class=header-anchor href=#103-%e5%88%86%e6%9e%90%e9%94%ae%e5%80%bc%e5%a4%a7%e5%b0%8f></a></h2><p>　　需求背景<br>redis的内存使用太大键值太多,不知道哪些键值占用的容量比较大,而且在线分析会影响性能.<br>安装工具</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>yum install python-pip gcc python-devel 
</span></span><span style=display:flex><span>cd /opt/
</span></span><span style=display:flex><span>git clone https://github.com/sripathikrishnan/redis-rdb-tools
</span></span><span style=display:flex><span>cd redis-rdb-tools
</span></span><span style=display:flex><span>python setup.py install
</span></span></code></pre></div><p>　　使用方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /data/redis_cluster/redis_6380/
</span></span><span style=display:flex><span>rdb -c memory redis_6380.rdb -f redis_6380.rdb.csv
</span></span></code></pre></div><p>　　分析rdb并导出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-dart data-lang=dart><span style=display:flex><span>awk <span style=color:#f92672>-</span>F <span style=color:#e6db74>&#39;,&#39;</span> <span style=color:#e6db74>&#39;{print $4,$2,$3,$1}&#39;</span> redis_6380.rdb.csv <span style=color:#f92672>|</span>sort  <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>6380.</span>txt
</span></span></code></pre></div><h2 id=104-监控过期键>10.4 监控过期键
<a class=header-anchor href=#104-%e7%9b%91%e6%8e%a7%e8%bf%87%e6%9c%9f%e9%94%ae></a></h2><p>　　需求背景<br>因为开发重复提交，导致电商网站优惠卷过期时间失效<br>问题分析<br>如果一个键已经设置了过期时间，这时候在set这个键，过期时间就会取消<br>解决思路<br>如何在不影响机器性能的前提下批量获取需要监控键过期时间<br>1.Keys * 查出来匹配的键名。然后循环读取ttl时间<br>2.scan * 范围查询键名。然后循环读取ttl时间<br>Keys 重操作，会影响服务器性能，除非是不提供服务的从节点<br>Scan 负担小，但是需要去多次才能取完，需要写脚本<br>脚本内容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat 01get_key.sh 
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/bash</span>
</span></span><span style=display:flex><span>key_num<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>&gt; key_name.log
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> line in <span style=color:#66d9ef>$(</span>cat key_list.txt<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> true
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        scan_num<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>redis-cli -h 192.168.47.75 -p <span style=color:#ae81ff>6380</span> SCAN <span style=color:#e6db74>${</span>key_num<span style=color:#e6db74>}</span> match <span style=color:#e6db74>${</span>line<span style=color:#e6db74>}</span><span style=color:#ae81ff>\*</span> count 1000|awk <span style=color:#e6db74>&#39;NR==1{print $0}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        key_name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>redis-cli -h 192.168.47.75 -p <span style=color:#ae81ff>6380</span> SCAN <span style=color:#e6db74>${</span>key_num<span style=color:#e6db74>}</span> match <span style=color:#e6db74>${</span>line<span style=color:#e6db74>}</span><span style=color:#ae81ff>\*</span> count 1000|awk <span style=color:#e6db74>&#39;NR&gt;1{print $0}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>        echo <span style=color:#e6db74>${</span>key_name<span style=color:#e6db74>}</span>|xargs -n <span style=color:#ae81ff>1</span> &gt;&gt; key_name.log
</span></span><span style=display:flex><span>        <span style=color:#f92672>((</span>key_num<span style=color:#f92672>=</span>scan_num<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>${</span>key_num<span style=color:#e6db74>}</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>           break
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><h1 id=第11章-故障案例>第11章 故障案例
<a class=header-anchor href=#%e7%ac%ac11%e7%ab%a0-%e6%95%85%e9%9a%9c%e6%a1%88%e4%be%8b></a></h1><p>　　作者：被运维耽误的厨子<br>链接：https://www.jianshu.com/p/2f93bb771469<br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></div><footer class=post-footer><div class=post-tags><a href=/tags/%e8%bf%90%e7%bb%b4>运维
</a><a href=/tags/linux>Linux
</a><a href=/tags/redis>Redis</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/content/ali-pay.jpg alt="szh - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/content/wechat-pay.jpg alt="szh - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Redis快速入门</li><li class=post-copyright-author><strong>本文作者： </strong>szh</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://szhiku.github.io/post/redis-fast-entry-2ltiy1.html title=Redis快速入门>https://szhiku.github.io/post/redis-fast-entry-2ltiy1.html</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/jenkins-entry-z2edmed.html rel=next title=Jenkins入门><i class="fa fa-chevron-left"></i> Jenkins入门</a></div><div class="post-nav-prev post-nav-item"><a href=/post/tomcat-detailed-explanation-z1jrrbj.html rel=prev title=Tomcat各端口详解>Tomcat各端口详解
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>szh</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.145.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel>
</a><a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云>
</a><a target=_blank href=https://webify.cloudbase.net title=Webify>Webify
</a><span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#87CEEB","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://szhiku.github.io/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o \n\n可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄\n(Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>